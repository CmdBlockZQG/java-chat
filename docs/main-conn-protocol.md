# 主连接通信协议

## 约定

用户id长2字节

### 数据包结构

| 字节数 | 类型  | 说明       |
| ------ | ----- | ---------- |
| 1      | uint8 | 数据包类型 |
|        |       | 数据包内容 |

### 消息类型

| 编号 | 内容       | 说明                      |
| ---- | ---------- | ------------------------- |
| 0    | 文本       | 纯文本消息                |
| 1    | 图片md5    | 图片消息                  |
| 2    | md5+文件名 | 离线文件，md5固定为32字节 |

## 对象

### 用户 user

| 字节数 | 类型   | 说明       |
| ------ | ------ | ---------- |
| 2      | uint16 | 用户id     |
| 1      | uint8  | 用户名长度 |
|        | string | 用户名     |

## 客户端->服务器

### 0 登陆

在打开主连接时发送。

| 字节数 | 类型   | 说明             |
| ------ | ------ | ---------------- |
| 2      | uint16 | 用户id           |
| 1      | uint8  | 用户名字符串长度 |
|        | string | 用户名           |

### 1 发送群消息

| 字节数 | 类型   | 说明         |
| ------ | ------ | ------------ |
| 1      | uint8  | 消息类型     |
| 2      | uint16 | 消息内容长度 |
|        | string | 消息内容     |

### 2 发送私聊消息

| 字节数 | 类型   | 说明         |
| ------ | ------ | ------------ |
| 2      | uint16 | 目标用户id   |
| 1      | uint8  | 消息类型     |
| 2      | uint16 | 消息内容长度 |
|        | string | 消息内容     |

## 服务器->客户端

### 0 登陆失败/强制下线

登陆失败或被强制下线时发送，发送完毕后服务器立刻断开连接

| 字节数 | 类型   | 说明         |
| ------ | ------ | ------------ |
| 1      | uint8  | 错误信息长度 |
|        | string | 错误信息     |

### 1 登陆成功

登陆成功

| 字节数 | 类型   | 说明             |
| ------ | ------ | ---------------- |
| 2      | uint16 | 在线用户数量     |
|        | user[] | 在线用户对象列表 |

### 2 用户上线

有用户上线时向全体发送

| 字节数 | 类型 | 说明     |
| ------ | ---- | -------- |
|        | user | 用户对象 |

### 3 用户离线

有用户离开时向全体发送

| 字节数 | 类型   | 说明   |
| ------ | ------ | ------ |
| 2      | uint16 | 用户id |

### 4 群消息

| 字节数 | 类型   | 说明          |
| ------ | ------ | ------------- |
| 2      | uint16 | 发送者id      |
| 4      | uint32 | unix时间戳(s) |
| 1      | uint8  | 消息类型      |
| 2      | uint16 | 消息内容长度  |
|        | string | 消息内容      |

### 5 私聊消息

| 字节数 | 类型   | 说明          |
| ------ | ------ | ------------- |
| 2      | uint16 | 发送者id      |
| 4      | uint32 | unix时间戳(s) |
| 1      | uint8  | 消息类型      |
| 2      | uint16 | 消息内容长度  |
|        | string | 消息内容      |

